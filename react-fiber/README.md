### React Fiber
Источник: **["Детальный React. Реконсиляция, рендеры, Fiber, виртуальное дерево"](https://habr.com/ru/articles/786102/)**.

---

### **1. Основная концепция Fiber**

*   **Что такое Fiber?** Это внутренний объект React, представляющий единицу "работы" (задачу) по обновлению компонента. Каждому компоненту соответствует свой Fiber-узел.
*   **Для чего нужен?** Fiber — это альтернатива старому стековому реконсилятору. Он позволяет разбивать работу по рендерингу на небольшие части, которые можно приостанавливать, приоритизировать и повторно использовать. Это основа для:
    *   **Concurrent Rendering** (параллельный рендеринг)
    *   **Приостановки рендера** для более важных задач (например, ввода пользователя)
    *   **Suspense**

### **2. Ключевые свойства Fiber**

Fiber — это связный список с большим количеством полей. Важнейшие для понимания:

*   `tag`: Тип Fiber (FunctionComponent, ClassComponent, HostComponent (DOM-узел), HostRoot (корень) и т.д.).
*   `type`: Ссылка на функцию/класс компонента или строку с тэгом (например, `'div'`).
*   `key`: Помогает React идентифицировать элементы в списке.
*   `stateNode`: Ссылка на реальный экземпляр (DOM-узел, экземпляр класса компонента).
*   `child`, `sibling`, `return`: Ссылки, формирующие **дерево Fiber** (не путать с Virtual DOM). Это односвязный список, где у каждого узла есть ссылка на первого ребенка, следующего "брата" и "родителя".
*   `pendingProps`, `memoizedProps`: Новые и старые пропсы. Их сравнение помогает определить, нужен ли ре-рендер.
*   `memoizedState`: Текущее состояние компонента (хуки хранят свое состояние здесь).
*   `alternate`: **Ключевое свойство.** Ссылка на "копию" Fiber. React работает с двумя деревьями:
    *   `current` — дерево, отображенное на экране.
    *   `workInProgress` — дерево, которое создается асинхронно.
*   `flags` (`effectTag`): Битовая маска, описывающая эффект, который нужно применить к узлу (например, `Placement`, `Update`, `Deletion`).
*   `lanes`: Механизм для определения **приоритета** обновления.

### **3. Архитектура и процесс рендеринга**

1.  **Пакет `react-reconciler`**: Это "движок" React. Он абстрагирует логику согласования (reconciliation) от конкретной платформы (DOM, React Native). Рендеры (как `react-dom`) — это реализация этого API.
2.  **Двухфазный рендеринг**: Процесс делится на две строго последовательные фазы, которые не могут прерываться.
    *   **Фаза Render (или Phase 1)**:
        *   **Асинхронная и прерываемая.** React вычисляет, какие изменения произошли в компонентах.
        *   Создает новое `workInProgress` дерево Fiber, обходя старое `current`.
        *   Здесь вызываются рендер-методы компонентов (`render`, тело функционального компонента) и хуки (`useMemo`, `useCallback`).
        *   **Результат:** План обновлений (список эффектов), но **без изменений в DOM**.
    *   **Фаза Commit (или Phase 2)**:
        *   **Синхронная и НЕпрерываемая.** React применяет все собранные изменения к DOM.
        *   Здесь происходят мутации DOM.
        *   Здесь вызываются синхронные хуки жизненного цикла (`useLayoutEffect`) и `componentDidMount`/`Update`.
        *   После commit'а `workInProgress` дерево становится `current`.

### **4. Как это работает на практике**

*   **Начало:** Вызов `root.render(<App />)` или `setState()` запускает процесс реконсиляции.
*   **Планировщик (Scheduler):** Получает задачи (Fiber-узлы) и планирует их выполнение, основываясь на приоритете (`lanes`). Работает в микротасках.
*   **Цикл обработки:** React обрабатывает Fiber-узлы по одному в цикле. Он может:
    *   Обработать узел, создать его детей и перейти к первому ребенку.
    *   Если детей нет, перейти к следующему "брату".
    *   Если "братьев" нет, "вернуться" к родителю.
*   **Двойное буферирование (Double Buffering):** Наличие `current` и `workInProgress` (через `alternate`) позволяет React готовить новое дерево в фоне, не затрагивая текущее. В момент commit'а происходит быстрая замена указателя.

---

### **Краткая выжимка:**

"**React Fiber — это архитектура реконсилятора, представленная в React 16. Ее основная сущность — это объект Fiber, который представляет работу по обновлению компонента. Fiber позволяет разбивать рендеринг на небольшие части, делая его прерываемым и приоритизируемым. Это реализуется через двойное буферирование: React асинхронно строит новое `workInProgress`-дерево, не трогая `current`-дерево, а затем в синхронной и непрерываемой фазе commit применяет все изменения разом. Это открыло дорогу для Concurrent Features в React.**"
